"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BaseServices = void 0;
const exceptions_1 = require("../constant/exceptions");
class BaseServices {
    constructor(model, errorConstructor = exceptions_1.CommonException) {
        this.model = model;
        this.errorConstructor = errorConstructor;
    }
    async count(query) {
        try {
            return await this.model.countDocuments(query);
        }
        catch (error) {
            throw error;
        }
    }
    async find(query, options, projection = { __v: 0 }) {
        try {
            return await this.model.find(query, projection, options);
        }
        catch (error) {
            throw error;
        }
    }
    async findOne(query, options, projection = { __v: 0 }) {
        try {
            return await this.model.findOne(query, projection, options);
        }
        catch (error) {
            throw error;
        }
    }
    async findById(id, options, projection = { __v: 0 }) {
        try {
            console.log('this.model: ', this.model);
            return await this.model.findOne({ _id: id, isDeleted: false }, projection, options);
        }
        catch (error) {
            throw error;
        }
    }
    async create(data, options) {
        try {
            const saved = await this.model.create([data], options);
            return await this.model.findById(saved[0]._id, {}, options);
        }
        catch (error) {
            if (error.code == 11000, error.name == "MongoError") {
                throw this.errorConstructor.AllreadyExist({ keyPattern: error.keyPattern, keyValue: error.keyValue }, this.model.collection.collectionName, error.message);
            }
            throw this.errorConstructor.UnknownError(error);
        }
    }
    async insertMany(data, options) {
        try {
            return await this.model.insertMany(data, options);
        }
        catch (error) {
            throw error;
        }
    }
    async deleteOne(query, options) {
        try {
            return await this.model.deleteOne(query, options);
        }
        catch (error) {
            throw this.errorConstructor.UnknownError(error);
        }
    }
    async updateOne(id, data, options) {
        try {
            await this.model.findOneAndUpdate({ _id: id, isDeleted: false }, data, options);
            return await this.model.findById(id);
        }
        catch (error) {
            throw this.errorConstructor.UnknownError(error);
        }
    }
    async updateOneByQuery(query, data, options) {
        try {
            return await this.model.findOneAndUpdate(query, data, options);
        }
        catch (error) {
            throw this.errorConstructor.UnknownError(error);
        }
    }
    async updateMany(query, data, options) {
        try {
            return await this.model.updateMany(query, data, options).exec();
        }
        catch (error) {
            throw error;
        }
    }
    async aggregate(pipeline, options) {
        try {
            return await this.model.aggregate(pipeline, options).allowDiskUse(true).exec();
        }
        catch (error) {
            throw error;
        }
    }
}
exports.BaseServices = BaseServices;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9zZXJ2aWNlL2Jhc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSx1REFBeUQ7QUFFekQsTUFBYSxZQUFZO0lBQ3ZCLFlBQW1CLEtBQW1CLEVBQVMsbUJBQW1CLDRCQUFlO1FBQTlELFVBQUssR0FBTCxLQUFLLENBQWM7UUFBUyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0lBQUksQ0FBQztJQUUvRSxLQUFLLENBQUMsS0FBSyxDQUFJLEtBQUs7UUFDekIsSUFBSTtZQUNGLE9BQU8sTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMvQztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsTUFBTSxLQUFLLENBQUM7U0FDYjtJQUNILENBQUM7SUFFTSxLQUFLLENBQUMsSUFBSSxDQUFJLEtBQUssRUFBRSxPQUFzQixFQUFFLGFBQXFCLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtRQUNqRixJQUFJO1lBQ0YsT0FBTyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDMUQ7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE1BQU0sS0FBSyxDQUFDO1NBQ2I7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLE9BQU8sQ0FBSSxLQUFLLEVBQUUsT0FBc0IsRUFBRSxhQUFxQixFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUU7UUFDcEYsSUFBSTtZQUNGLE9BQU8sTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzdEO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxNQUFNLEtBQUssQ0FBQztTQUNiO0lBQ0gsQ0FBQztJQUVNLEtBQUss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QUFDLENBQUM7U0FDaEU7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNqRDtJQUNILENBQUM7SUFFTSxLQUFLLENBQUMsVUFBVSxDQUFJLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBc0I7UUFDNUQsSUFBSTtZQUNGLE9BQU8sTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2pFO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxNQUFNLEtBQUssQ0FBQztTQUNiO0lBQ0gsQ0FBQztJQUVNLEtBQUssQ0FBQyxTQUFTLENBQUksUUFBb0IsRUFBRSxPQUFRO1FBQ3RELElBQUk7WUFDRixPQUFPLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNoRjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsTUFBTSxLQUFLLENBQUM7U0FDYjtJQUNILENBQUM7Q0FFRjtBQWxHRCxvQ0FrR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2RlbFR5cGUgfSBmcm9tICdAdHlwZWdvb3NlL3R5cGVnb29zZS9saWIvdHlwZXMnO1xyXG5pbXBvcnQgeyBRdWVyeU9wdGlvbnMgfSBmcm9tICdtb25nb29zZSc7XHJcbmltcG9ydCB7IENvbW1vbkV4Y2VwdGlvbiB9IGZyb20gJy4uL2NvbnN0YW50L2V4Y2VwdGlvbnMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEJhc2VTZXJ2aWNlczxUPiB7XHJcbiAgY29uc3RydWN0b3IocHVibGljIG1vZGVsOiBNb2RlbFR5cGU8VD4sIHB1YmxpYyBlcnJvckNvbnN0cnVjdG9yID0gQ29tbW9uRXhjZXB0aW9uKSB7IH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGNvdW50PFQ+KHF1ZXJ5KSB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlbC5jb3VudERvY3VtZW50cyhxdWVyeSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBmaW5kPFQ+KHF1ZXJ5LCBvcHRpb25zPzogUXVlcnlPcHRpb25zLCBwcm9qZWN0aW9uOiBvYmplY3QgPSB7IF9fdjogMCB9KSB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlbC5maW5kKHF1ZXJ5LCBwcm9qZWN0aW9uLCBvcHRpb25zKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRocm93IGVycm9yO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGZpbmRPbmU8VD4ocXVlcnksIG9wdGlvbnM/OiBRdWVyeU9wdGlvbnMsIHByb2plY3Rpb246IG9iamVjdCA9IHsgX192OiAwIH0pIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLm1vZGVsLmZpbmRPbmUocXVlcnksIHByb2plY3Rpb24sIG9wdGlvbnMpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZmluZEJ5SWQ8VD4oaWQ6IHN0cmluZywgb3B0aW9ucz86IFF1ZXJ5T3B0aW9ucywgcHJvamVjdGlvbjogb2JqZWN0ID0geyBfX3Y6IDAgfSkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc29sZS5sb2coJ3RoaXMubW9kZWw6ICcsIHRoaXMubW9kZWwpO1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlbC5maW5kT25lKHsgX2lkOiBpZCwgaXNEZWxldGVkOiBmYWxzZSB9LCBwcm9qZWN0aW9uLCBvcHRpb25zKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRocm93IGVycm9yO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGNyZWF0ZTxUPihkYXRhLCBvcHRpb25zPykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3Qgc2F2ZWQgPSBhd2FpdCB0aGlzLm1vZGVsLmNyZWF0ZShbZGF0YV0sIG9wdGlvbnMpO1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlbC5maW5kQnlJZChzYXZlZFswXS5faWQsIHt9LCBvcHRpb25zKTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGlmIChlcnJvci5jb2RlID09IDExMDAwLCBlcnJvci5uYW1lID09IFwiTW9uZ29FcnJvclwiKSB7XHJcbiAgICAgICAgdGhyb3cgdGhpcy5lcnJvckNvbnN0cnVjdG9yLkFsbHJlYWR5RXhpc3QoeyBrZXlQYXR0ZXJuOiBlcnJvci5rZXlQYXR0ZXJuLCBrZXlWYWx1ZTogZXJyb3Iua2V5VmFsdWUgfSwgdGhpcy5tb2RlbC5jb2xsZWN0aW9uLmNvbGxlY3Rpb25OYW1lLCBlcnJvci5tZXNzYWdlLClcclxuICAgICAgfVxyXG4gICAgICB0aHJvdyB0aGlzLmVycm9yQ29uc3RydWN0b3IuVW5rbm93bkVycm9yKGVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBpbnNlcnRNYW55PFQ+KGRhdGEsIG9wdGlvbnM/KSB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlbC5pbnNlcnRNYW55KGRhdGEsIG9wdGlvbnMpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZGVsZXRlT25lPFQ+KHF1ZXJ5LCBvcHRpb25zPzogUXVlcnlPcHRpb25zKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlbC5kZWxldGVPbmUocXVlcnksIG9wdGlvbnMpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhyb3cgdGhpcy5lcnJvckNvbnN0cnVjdG9yLlVua25vd25FcnJvcihlcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuXHJcbiAgcHVibGljIGFzeW5jIHVwZGF0ZU9uZTxUPihpZCwgZGF0YSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9ucykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgYXdhaXQgdGhpcy5tb2RlbC5maW5kT25lQW5kVXBkYXRlKHsgX2lkOiBpZCwgaXNEZWxldGVkOiBmYWxzZSB9LCBkYXRhLCBvcHRpb25zKTtcclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubW9kZWwuZmluZEJ5SWQoaWQpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhyb3cgdGhpcy5lcnJvckNvbnN0cnVjdG9yLlVua25vd25FcnJvcihlcnJvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgdXBkYXRlT25lQnlRdWVyeTxUPihxdWVyeSwgZGF0YSwgb3B0aW9ucz86IFF1ZXJ5T3B0aW9ucykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubW9kZWwuZmluZE9uZUFuZFVwZGF0ZShxdWVyeSwgZGF0YSwgb3B0aW9ucyk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aHJvdyB0aGlzLmVycm9yQ29uc3RydWN0b3IuVW5rbm93bkVycm9yKGVycm9yKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyB1cGRhdGVNYW55PFQ+KHF1ZXJ5LCBkYXRhLCBvcHRpb25zPzogUXVlcnlPcHRpb25zKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlbC51cGRhdGVNYW55KHF1ZXJ5LCBkYXRhLCBvcHRpb25zKS5leGVjKCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBhZ2dyZWdhdGU8VD4ocGlwZWxpbmU6IEFycmF5PGFueT4sIG9wdGlvbnM/KSB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5tb2RlbC5hZ2dyZWdhdGUocGlwZWxpbmUsIG9wdGlvbnMpLmFsbG93RGlza1VzZSh0cnVlKS5leGVjKCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG59XHJcbiJdfQ==